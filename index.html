<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#25D366">
    <title>Batanai Chat | Zimbabwe Light Messenger</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* COMPREHENSIVE CSS WITH ALL FEATURES */
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #667781;
            --dark: #0C0C0C;
            --light: #F0F2F5;
            --white: #FFFFFF;
            --danger: #FF3860;
            --success: #00D95F;
            --warning: #FFC107;
            --purple: #9C27B0;
            --chat-bg: linear-gradient(135deg, #667781 0%, #075E54 100%);
            --message-sent: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            --message-received: linear-gradient(135deg, #FFFFFF 0%, #F0F2F5 100%);
            
            /* Note Colors */
            --note-blue: #2196F3;
            --note-green: #4CAF50;
            --note-yellow: #FFEB3B;
            --note-orange: #FF9800;
            --note-pink: #E91E63;
            --note-purple: #9C27B0;
            --note-red: #F44336;
            --note-teal: #009688;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--chat-bg);
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* LANDING PAGE */
        .landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .landing-container {
            max-width: 500px;
            margin: 0 auto;
            padding-top: 40px;
        }
        
        .landing-logo {
            width: 100px;
            height: 100px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 10px 30px rgba(37, 211, 102, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .landing-title {
            text-align: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 800;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .landing-subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .developer-credit {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            margin: 15px 0;
            font-style: italic;
        }
        
        .contact-info {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin: 15px 0;
            line-height: 1.5;
        }
        
        .pricing-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 900;
            display: inline-block;
            margin: 20px auto;
            text-align: center;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .features-list {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .feature-item {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }
        
        /* BUTTONS */
        .btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin: 12px 0;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            font-family: inherit;
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #667781 100%);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid white;
            box-shadow: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #FF9800 100%);
            color: #333;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #C2185B 100%);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, var(--purple) 0%, #673AB7 100%);
        }
        
        /* ADMIN BUTTON */
        .admin-btn-landing {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--warning) 0%, #FF9800 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            z-index: 1001;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 193, 7, 0.4);
            transition: all 0.3s;
        }
        
        .admin-btn-landing:hover {
            transform: scale(1.1);
        }
        
        /* SHARE BUTTON */
        .share-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            z-index: 1001;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.4);
            transition: all 0.3s;
            border: 3px solid white;
        }
        
        .share-btn:hover {
            transform: scale(1.1);
        }
        
        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalSlide 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        
        .modal-header h2 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* FORMS */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: rgba(0,0,0,0.03);
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }
        
        .phone-input {
            display: flex;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .phone-input:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }
        
        .country-code {
            padding: 15px;
            background: rgba(0,0,0,0.05);
            min-width: 90px;
            text-align: center;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .phone-input input {
            flex: 1;
            border: none;
            padding: 15px;
            font-family: inherit;
            background: transparent;
        }
        
        .phone-input input:focus {
            outline: none;
        }
        
        /* APP LAYOUT */
        .app-container {
            display: none;
            height: 100vh;
            background: var(--light);
        }
        
        .app-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .chat-layout {
            display: flex;
            height: 100vh;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 35%;
            min-width: 350px;
            background: white;
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 30px rgba(0,0,0,0.05);
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background-size: cover;
            background-position: center;
            background-color: white;
            overflow: hidden;
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-details h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-details p {
            font-size: 0.85rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 10px;
        }
        
        .sidebar-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .sidebar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* TABS */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        
        .tab:hover {
            background: rgba(0,0,0,0.02);
        }
        
        /* SEARCH */
        .search-container {
            padding: 20px;
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 15px;
            font-size: 0.95rem;
            font-family: inherit;
            background: rgba(0,0,0,0.03);
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }
        
        /* CHATS LIST */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            background: white;
            padding: 10px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            background: white;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .chat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.05) 0%, rgba(37, 211, 102, 0.1) 100%);
        }
        
        .chat-item.active {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(37, 211, 102, 0.2) 100%);
            border-color: var(--primary);
            animation: pulseContact 2s infinite;
        }
        
        @keyframes pulseContact {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.2); }
            50% { box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); }
        }
        
        .chat-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 1.2rem;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
            background-color: var(--primary); /* Default background if no image */
            overflow: hidden;
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-info h4 {
            font-size: 1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-info p {
            font-size: 0.85rem;
            color: var(--secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* CHAT AREA - BEAUTIFUL BACKGROUND */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(rgba(240, 242, 245, 0.9), rgba(232, 234, 237, 0.9)), 
                        linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(18, 140, 126, 0.1));
            position: relative;
            overflow: hidden;
        }
        
        .chat-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(37, 211, 102, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(18, 140, 126, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(102, 119, 129, 0.05) 0%, transparent 50%);
            z-index: 0;
        }
        
        .no-chat-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            color: var(--secondary);
            position: relative;
            z-index: 1;
        }
        
        .no-chat-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
            animation: floatIcon 3s infinite ease-in-out;
        }
        
        @keyframes floatIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        /* CHAT HEADER */
        .chat-header {
            display: none;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 20px rgba(0,0,0,0.05);
        }
        
        .back-to-contacts {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .back-to-contacts:hover {
            background: rgba(0,0,0,0.05);
            transform: translateX(-5px);
        }
        
        .chat-contact {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .chat-contact-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
            background-color: var(--primary); /* Default background if no image */
            overflow: hidden;
        }
        
        .chat-contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-contact-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-contact-info p {
            font-size: 0.85rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .chat-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        
        .chat-action-btn:hover {
            background: var(--light);
            transform: scale(1.1);
        }
        
        .contact-menu {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 100;
            display: none;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .contact-menu.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .contact-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark);
            text-decoration: none;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .contact-menu-item:last-child {
            border-bottom: none;
        }
        
        .contact-menu-item:hover {
            background: var(--light);
            padding-left: 25px;
        }
        
        .contact-menu-item.danger {
            color: var(--danger);
        }
        
        .contact-menu-item.warning {
            color: var(--warning);
        }
        
        .contact-menu-item.purple {
            color: var(--purple);
        }
        
        /* MESSAGES CONTAINER */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.sent {
            justify-content: flex-end;
            animation-delay: 0.1s;
        }
        
        .message.received {
            justify-content: flex-start;
            animation-delay: 0.2s;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: bubblePop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes bubblePop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .message.sent .message-bubble {
            background: var(--message-sent);
            color: white;
            border-bottom-right-radius: 8px;
        }
        
        .message.received .message-bubble {
            background: var(--message-received);
            color: var(--dark);
            border-bottom-left-radius: 8px;
        }
        
        .message-text {
            font-size: 1rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 8px;
            text-align: right;
        }
        
        .message-status {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* INPUT */
        .input-container {
            display: none;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            gap: 15px;
            position: relative;
            z-index: 2;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
        }
        
        .message-input {
            flex: 1;
            padding: 18px;
            background: white;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 15px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }
        
        .send-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(37, 211, 102, 0.3);
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
        }
        
        /* ADMIN DASHBOARD */
        .admin-dashboard {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            z-index: 3000;
            overflow-y: auto;
            color: white;
        }
        
        .admin-dashboard.active {
            display: block;
            animation: slideInLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .admin-header {
            padding: 25px 30px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .admin-header h1 {
            color: white;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-search-container {
            padding: 20px 30px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-search-box {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .admin-search-box input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .admin-search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,255,255,0.15);
        }
        
        .admin-search-box button {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .admin-search-box button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            animation: slideUp 0.5s ease-out;
            animation-fill-mode: both;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.08);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        .stat-icon {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }
        
        .users-list {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .user-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
            animation: fadeInUp 0.5s ease-out;
            animation-fill-mode: both;
            backdrop-filter: blur(10px);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-5px);
        }
        
        .user-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }
        
        .user-card-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255,255,255,0.2);
            background-color: rgba(255,255,255,0.1);
        }
        
        .user-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-card-info h4 {
            color: white;
            margin-bottom: 5px;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-card-info p {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* STATUS BADGES */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .status-active {
            background: rgba(37, 211, 102, 0.2);
            color: var(--primary);
        }
        
        .status-inactive {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .status-blocked {
            background: rgba(255, 56, 96, 0.2);
            color: var(--danger);
        }
        
        .status-premium {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 165, 0, 0.2) 100%);
            color: #FFA500;
        }
        
        .status-pending {
            background: rgba(156, 39, 176, 0.2);
            color: var(--purple);
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(30px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 4000;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 350px;
            border-left: 5px solid var(--primary);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-icon {
            font-size: 1.3rem;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-text strong {
            display: block;
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .notification-text p {
            color: var(--secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* INACTIVE OVERLAY */
        .inactive-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .inactive-content {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalSlide 0.5s ease;
        }
        
        /* PROFILE PREVIEW */
        .profile-upload {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--light);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }
        
        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background: var(--light);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-weight: 600;
        }
        
        .upload-btn:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        
        .upload-btn input {
            display: none;
        }
        
        /* PAYMENT DETAILS */
        .payment-details {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .payment-option {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            text-align: left;
        }
        
        .payment-option h4 {
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* NOTES SECTION */
        .notes-section {
            margin: 30px 0;
        }
        
        .notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .note-item {
            padding: 15px;
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .note-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .note-content {
            flex: 1;
            margin-bottom: 10px;
        }
        
        .note-date {
            font-size: 0.7rem;
            opacity: 0.9;
            text-align: right;
        }
        
        .note-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 5px;
        }
        
        .note-item:hover .note-actions {
            display: flex;
        }
        
        .note-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .note-action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        /* Note Colors */
        .note-blue {
            background: linear-gradient(135deg, var(--note-blue) 0%, #1976D2 100%);
        }
        
        .note-green {
            background: linear-gradient(135deg, var(--note-green) 0%, #388E3C 100%);
        }
        
        .note-yellow {
            background: linear-gradient(135deg, var(--note-yellow) 0%, #FBC02D 100%);
            color: #333;
        }
        
        .note-orange {
            background: linear-gradient(135deg, var(--note-orange) 0%, #F57C00 100%);
        }
        
        .note-pink {
            background: linear-gradient(135deg, var(--note-pink) 0%, #C2185B 100%);
        }
        
        .note-purple {
            background: linear-gradient(135deg, var(--note-purple) 0%, #7B1FA2 100%);
        }
        
        .note-red {
            background: linear-gradient(135deg, var(--note-red) 0%, #D32F2F 100%);
        }
        
        .note-teal {
            background: linear-gradient(135deg, var(--note-teal) 0%, #00796B 100%);
        }
        
        .color-picker {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--dark);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .chat-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-width: auto;
                height: 100%;
            }
            
            .chat-area {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
            }
            
            .chat-area.active {
                display: flex;
            }
            
            .share-btn {
                bottom: 100px;
                left: 20px;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-card-header {
                min-width: 200px;
            }
            
            .user-card-actions {
                width: 100%;
                justify-content: center;
            }
            
            .notification {
                top: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }
            
            .notes-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #075E54 100%);
        }
    </style>
</head>
<body>
    <!-- LANDING PAGE -->
    <div class="landing-page" id="landingPage">
        <button class="admin-btn-landing" id="adminBtnLanding" title="Admin Login">üîí</button>
        
        <div class="landing-container">
            <div class="landing-logo">üí¨</div>
            <h1 class="landing-title">Batanai Chat</h1>
            <p class="landing-subtitle">Zimbabwe's Premium Messenger<br>Ultra-Light ‚Ä¢ $1 for 2 Weeks ‚Ä¢ Unlimited Chats</p>
            
            <div class="developer-credit">
                Developed by Lucky Munyanyiwa | Proudly Zimbabwean üáøüáº
            </div>
            
            <div class="contact-info">
                ‚úâÔ∏è Email: hr4u@fastservice.com<br>
                üì± WhatsApp Support Only: +27714337743
            </div>
            
            <div class="pricing-badge">$1 = 2 WEEKS UNLIMITED</div>
            
            <div class="features-list">
                <div class="feature-item">‚úì Real-time messaging with beautiful interface</div>
                <div class="feature-item">‚úì Ultra-low data usage (98% less than WhatsApp)</div>
                <div class="feature-item">‚úì Text messaging optimized for Zimbabwe networks</div>
                <div class="feature-item">‚úì Contact management with block/delete options</div>
                <div class="feature-item">‚úì Top-up options for contacts</div>
                <div class="feature-item">‚úì Profile with subscription tracking</div>
                <div class="feature-item">‚úì Admin dashboard with real-time updates</div>
                <div class="feature-item">‚úì Works on Econet, NetOne, Telecel</div>
                <div class="feature-item">‚úì Real-time message delivery between users</div>
                <div class="feature-item">‚úì Cross-city messaging (Harare to Bulawayo, etc.)</div>
                <div class="feature-item">‚úì Personal notes with color coding</div>
            </div>
            
            <button class="btn" id="getStartedBtn">üöÄ Get Started</button>
            <button class="btn btn-secondary" id="loginBtnLanding">üîë Login with PIN</button>
            <button class="btn btn-outline" id="makePaymentBtn">üí≥ Make Payment</button>
            
            <div style="text-align: center; margin-top: 25px;">
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                    <a href="#" id="privacyPolicyLink" style="color: white; text-decoration: underline; font-weight: 600;">üõ°Ô∏è Privacy Policy</a>
                </p>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Complete Your Registration</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-details">
                    <h3 style="color: white; margin-bottom: 20px;">Payment Required</h3>
                    <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                        To activate your account and start chatting, please complete the payment of <strong>$1 for 2 weeks</strong>.
                    </p>
                    
                    <div class="payment-option">
                        <h4>üì± EcoCash Payment</h4>
                        <p><strong>Send $1 to:</strong> Kudakwashe Jani<br>
                        <strong>Phone Number:</strong> +263 77 251 7830<br>
                        <strong>Reference:</strong> BATANAI<span id="paymentReference"></span></p>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <h4 style="color: white; margin-bottom: 10px;">üì± WhatsApp Activation Proof</h4>
                        <p style="color: rgba(255, 255, 255, 0.9);">
                            After payment, send your proof to:<br>
                            <strong>WhatsApp Only:</strong> +27714337743<br>
                            <strong>Include your phone number and payment reference</strong>
                        </p>
                        <button class="btn" style="margin-top: 15px; width: 100%;" id="sendPaymentProofBtn">
                            üì± Send Proof to WhatsApp
                        </button>
                    </div>
                    
                    <button class="btn" style="margin-top: 20px;" id="understandPaymentBtn">
                        ‚úÖ I Understand
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOP-UP MODAL -->
    <div class="modal" id="topupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Extend Your Subscription</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-details">
                    <h3 style="color: white; margin-bottom: 20px;">Add More Time</h3>
                    <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                        Extend your subscription to continue enjoying unlimited chatting.
                    </p>
                    
                    <div class="payment-option">
                        <h4>üì± EcoCash Payment</h4>
                        <p><strong>Send payment to:</strong> Kudakwashe Jani<br>
                        <strong>Phone Number:</strong> +263 77 251 7830<br>
                        <strong>Reference:</strong> EXTEND<span id="topupReference"></span></p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label" style="color: white;">Number of Weeks</label>
                        <select id="topupWeeks" class="form-control" style="background: rgba(255, 255, 255, 0.9);">
                            <option value="2">2 Weeks - $1</option>
                            <option value="4">4 Weeks - $2</option>
                            <option value="8">8 Weeks - $4</option>
                            <option value="12">12 Weeks - $6</option>
                        </select>
                    </div>
                    
                    <button class="btn" style="margin-top: 20px;" id="sendTopupProofBtn">
                        üì± Send Proof to WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOP-UP FOR CONTACT MODAL -->
    <div class="modal" id="topupContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ü§ù Top Up for Contact</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-details">
                    <h3 style="color: white; margin-bottom: 20px;">Top Up for <span id="topupContactName"></span></h3>
                    <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                        Purchase subscription for your contact. Admin will activate their account.
                    </p>
                    
                    <div class="payment-option">
                        <h4>üì± EcoCash Payment</h4>
                        <p><strong>Send $1 to:</strong> Kudakwashe Jani<br>
                        <strong>Phone Number:</strong> +263 77 251 7830<br>
                        <strong>Reference:</strong> CONTACT<span id="topupContactReference"></span></p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label" style="color: white;">Subscription Period</label>
                        <select id="topupContactWeeks" class="form-control" style="background: rgba(255, 255, 255, 0.9);">
                            <option value="2">2 Weeks - $1</option>
                            <option value="4">4 Weeks - $2</option>
                            <option value="8">8 Weeks - $4</option>
                        </select>
                    </div>
                    
                    <button class="btn" style="margin-top: 20px;" id="sendContactTopupProofBtn">
                        üì± Send Proof to WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîë Login with PIN</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">4-Digit PIN</label>
                    <input type="password" id="loginPin" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4" pattern="[0-9]{4}" required>
                </div>
                <button class="btn" id="loginBtn">üîë Login</button>
                <p style="text-align: center; margin-top: 20px; color: #666;">
                    Don't have an account? 
                    <a href="#" id="registerLink" style="color: var(--primary); font-weight: 700;">Register here</a>
                </p>
            </div>
        </div>
    </div>

    <!-- REGISTER MODAL -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Create Account</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="profile-upload">
                    <div class="profile-preview" id="registerProfilePreview" style="background-size: cover; background-position: center;">
                        <div style="font-size: 2.5rem; color: var(--secondary);">üë§</div>
                    </div>
                    <label class="upload-btn">
                        üìÅ Upload Profile Picture
                        <input type="file" id="registerProfilePicture" accept="image/*">
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="John Doe" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üáøüáº Zimbabwe Phone Number</label>
                    <div class="phone-input">
                        <div class="country-code">+263</div>
                        <input type="tel" id="registerPhone" placeholder="771234567" maxlength="9" pattern="[0-9]{9}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Create 4-Digit PIN</label>
                    <input type="password" id="registerPin" class="form-control" placeholder="Enter 4-digit PIN" maxlength="4" pattern="[0-9]{4}" required>
                    <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                        Remember this PIN! You'll use it to login from any device.
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm PIN</label>
                    <input type="password" id="registerPinConfirm" class="form-control" placeholder="Confirm 4-digit PIN" maxlength="4" pattern="[0-9]{4}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">City</label>
                    <select id="registerCity" class="form-control" required>
                        <option value="">Select your city</option>
                        <option value="Harare">Harare</option>
                        <option value="Bulawayo">Bulawayo</option>
                        <option value="Chitungwiza">Chitungwiza</option>
                        <option value="Mutare">Mutare</option>
                        <option value="Gweru">Gweru</option>
                        <option value="Kwekwe">Kwekwe</option>
                        <option value="Kadoma">Kadoma</option>
                        <option value="Masvingo">Masvingo</option>
                        <option value="Chegutu">Chegutu</option>
                        <option value="Zvishavane">Zvishavane</option>
                        <option value="Bindura">Bindura</option>
                        <option value="Beitbridge">Beitbridge</option>
                        <option value="Victoria Falls">Victoria Falls</option>
                        <option value="Kariba">Kariba</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <button class="btn" id="registerBtn">üìù Create Account</button>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîí Admin Login</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Admin Password</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
                <button class="btn" id="adminLoginBtn">üîí Login as Admin</button>
            </div>
        </div>
    </div>

    <!-- PRIVACY POLICY MODAL -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõ°Ô∏è Privacy Policy</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                    <h3 style="margin-bottom: 15px;">Data Collection</h3>
                    <p style="margin-bottom: 15px; color: #666;">We collect only necessary information to provide our messaging service:</p>
                    <ul style="margin-bottom: 20px; padding-left: 20px; color: #666;">
                        <li>Phone number for account creation</li>
                        <li>Profile name and city</li>
                        <li>Your messages (stored locally on your device)</li>
                        <li>Contact information you provide</li>
                    </ul>
                    
                    <h3 style="margin-bottom: 15px;">Data Usage</h3>
                    <p style="margin-bottom: 15px; color: #666;">Your data is used solely for:</p>
                    <ul style="margin-bottom: 20px; padding-left: 20px; color: #666;">
                        <li>Account authentication and management</li>
                        <li>Enabling messaging between contacts</li>
                        <li>Improving user experience</li>
                        <li>Subscription management</li>
                    </ul>
                    
                    <h3 style="margin-bottom: 15px;">Data Protection</h3>
                    <p style="margin-bottom: 15px; color: #666;">We prioritize your privacy:</p>
                    <ul style="margin-bottom: 20px; padding-left: 20px; color: #666;">
                        <li>Messages are stored locally on your device</li>
                        <li>No third-party data sharing</li>
                        <li>Secure account authentication</li>
                        <li>End-to-end message encryption</li>
                    </ul>
                    
                    <h3 style="margin-bottom: 15px;">Contact Support</h3>
                    <p style="color: #666;">For privacy concerns, contact us via WhatsApp only: +27714337743 or Email: hr4u@fastservice.com</p>
                </div>
                <button class="btn" onclick="getElement('privacyModal').classList.remove('active')" style="margin-top: 20px;">‚úÖ I Understand</button>
            </div>
        </div>
    </div>

    <!-- NOTES MODAL -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Personal Notes</h2>
                <button class="close-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Note</label>
                    <textarea id="newNoteText" class="form-control" placeholder="Type your note here..." rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Note Color</label>
                    <div class="color-picker">
                        <div class="color-option note-blue selected" data-color="blue" style="background: var(--note-blue);"></div>
                        <div class="color-option note-green" data-color="green" style="background: var(--note-green);"></div>
                        <div class="color-option note-yellow" data-color="yellow" style="background: var(--note-yellow);"></div>
                        <div class="color-option note-orange" data-color="orange" style="background: var(--note-orange);"></div>
                        <div class="color-option note-pink" data-color="pink" style="background: var(--note-pink);"></div>
                        <div class="color-option note-purple" data-color="purple" style="background: var(--note-purple);"></div>
                        <div class="color-option note-red" data-color="red" style="background: var(--note-red);"></div>
                        <div class="color-option note-teal" data-color="teal" style="background: var(--note-teal);"></div>
                    </div>
                </div>
                
                <button class="btn" id="addNoteBtn">üìù Add Note</button>
                
                <div class="notes-section">
                    <h3 style="margin-bottom: 15px; color: var(--dark);">My Notes</h3>
                    <div class="notes-container" id="notesContainer">
                        <!-- Notes will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INACTIVE OVERLAY -->
    <div class="inactive-overlay" id="inactiveOverlay">
        <div class="inactive-content">
            <div style="font-size: 4rem; color: var(--warning); margin-bottom: 20px;">‚è≥</div>
            <h2 style="color: white; margin-bottom: 15px;">Account Pending Activation</h2>
            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                Your account is currently inactive. Please wait for admin approval or complete your payment to activate your account.
            </p>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 25px;">
                <p style="color: white; font-size: 0.9rem;">
                    <strong>Status:</strong> Waiting for admin activation
                </p>
            </div>
            
            <button class="btn" id="loginInactiveBtn">üîë Try Login Again</button>
            <button class="btn btn-secondary" style="margin-top: 15px;" id="makePaymentInactiveBtn">üí≥ Make Payment</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="appContainer">
        <div class="chat-layout">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar" id="userAvatar" style="background-size: cover; background-position: center;">U</div>
                    <div class="user-details">
                        <h3 id="userName">Loading...</h3>
                        <p id="userStatus">
                            <span class="status-badge status-inactive">Checking...</span>
                        </p>
                    </div>
                    <div class="sidebar-actions">
                        <button class="sidebar-btn" id="profileBtn" title="Profile">üë§</button>
                        <button class="sidebar-btn" id="newContactBtn" title="New Contact">Ôºã</button>
                        <button class="sidebar-btn" id="notesBtn" title="Notes">üìù</button>
                        <button class="sidebar-btn" id="blockedContactsBtn" title="Blocked Contacts">üö´</button>
                        <button class="sidebar-btn" id="logoutBtn" title="Logout">‚éã</button>
                    </div>
                </div>
                
                <!-- TABS -->
                <div class="tabs">
                    <button class="tab active" id="contactsTab">Contacts</button>
                    <button class="tab" id="blockedTab">Blocked</button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchContacts" placeholder="Search contacts...">
                    </div>
                </div>
                
                <div class="chats-list" id="chatsList">
                    <!-- Contacts will load here -->
                </div>
                
                <div class="chats-list" id="blockedList" style="display: none;">
                    <!-- Blocked contacts will load here -->
                </div>
            </div>
            
            <!-- CHAT AREA -->
            <div class="chat-area" id="chatArea">
                <div class="no-chat-selected" id="noChatSelected">
                    <div class="no-chat-icon">üí¨</div>
                    <h3 style="margin-bottom: 10px;">Welcome to Batanai Chat</h3>
                    <p style="margin-bottom: 25px; color: #666; max-width: 400px;">
                        Select a contact from your list to start chatting, or add new contacts to connect with friends and family.
                    </p>
                    <button class="btn" id="addFirstContactBtn" style="max-width: 250px;">Ôºã Add Your First Contact</button>
                </div>
                
                <!-- Active Chat View -->
                <div class="chat-header" id="chatHeader">
                    <button class="back-to-contacts" id="backToContactsBtn">‚Üê</button>
                    <div class="chat-contact">
                        <div class="chat-contact-avatar" id="currentChatAvatar" style="background-size: cover; background-position: center;">C</div>
                        <div class="chat-contact-info">
                            <h3 id="currentChatName">
                                <span>Contact Name</span>
                                <button class="contact-topup-btn" id="contactTopupBtn" title="Top-up for contact" style="background: none; border: none; color: var(--purple); font-size: 1rem; cursor: pointer;">üí∞</button>
                            </h3>
                            <p id="currentChatStatus">
                                <span class="status-badge status-inactive">Offline</span>
                                <span id="contactCity"></span>
                            </p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" id="contactMenuBtn">‚ãÆ</button>
                        <div class="contact-menu" id="contactMenu">
                            <a href="#" class="contact-menu-item" id="viewContactProfileBtn">
                                üë§ View Profile
                            </a>
                            <a href="#" class="contact-menu-item warning" id="blockUnblockContactBtn">
                                ‚ö†Ô∏è Block Contact
                            </a>
                            <a href="#" class="contact-menu-item purple" id="topupContactBtn">
                                üí∞ Top Up for Contact
                            </a>
                            <a href="#" class="contact-menu-item danger" id="deleteContactBtn">
                                üóëÔ∏è Delete Contact
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will load here -->
                </div>
                
                <div class="input-container" id="inputContainer">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." autocomplete="off">
                    <button class="send-btn" id="sendBtn">‚Üë</button>
                </div>
            </div>
        </div>
        
        <!-- SHARE BUTTON -->
        <button class="share-btn" id="shareBtn" title="Share App">üì§</button>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-header">
            <h1>üëë Admin Dashboard</h1>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" id="backToChatBtn" style="padding: 10px 20px;">‚Üê Back to Chat</button>
                <button class="btn btn-danger" id="adminLogoutBtn" style="padding: 10px 20px;">‚éã Logout Admin</button>
            </div>
        </div>
        
        <div class="admin-search-container">
            <div class="admin-search-box">
                <input type="text" id="adminSearchInput" placeholder="Search by phone number or name...">
                <button id="adminSearchBtn">üîç Search</button>
            </div>
        </div>
        
        <div class="admin-stats" id="adminStats">
            <!-- Stats will load here -->
        </div>
        
        <div class="users-list" id="usersList">
            <!-- Users will load here -->
        </div>
    </div>

    <!-- NOTIFICATION CONTAINER -->
    <div id="notificationContainer"></div>

    <script>
        // ========== SUPABASE CONFIG ==========
        const SUPABASE_URL = 'https://mbdoiqaefuewyialiqcw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1iZG9pcWFlZnVld3lpYWxpcWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMTc2OTksImV4cCI6MjA4NDc5MzY5OX0.lqEIzPO-hZCA5u3REYLcEGT0AtOPtm4whJ4i34yAcqw';
        
        const ADMIN_PASSWORD = "Luncumo@5";
        const WHATSAPP_SUPPORT = "+27714337743";
        const EMAIL_SUPPORT = "hr4u@fastservice.com";
        const APP_URL = "https://batanai-chat-zimbabwe.vercel.app";
        
        let supabaseClient = null;
        let currentUser = null;
        let currentContact = null;
        let contacts = [];
        let blockedContacts = [];
        let messages = new Map();
        let allUsers = [];
        let messageCounter = 0;
        let realtimeSubscription = null;
        let unsentMessages = [];
        let isOnline = navigator.onLine;
        let currentTab = 'contacts';
        let notes = [];
        let selectedNoteColor = 'blue';
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Batanai Chat Initializing...');
            
            // Setup online/offline detection
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Initialize Supabase
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase connected');
                
                // Test connection
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count', { count: 'exact', head: true })
                    .limit(1);
                    
                if (error) {
                    console.warn('‚ö†Ô∏è Database connection limited, using fallback');
                } else {
                    console.log('‚úÖ Database connection successful');
                }
            } catch (error) {
                console.error('‚ùå Supabase error:', error);
                // Don't show notification to user
            }
            
            // Check for existing user
            await checkExistingUser();
            setupEventListeners();
            
            // Load unsent messages
            loadUnsentMessages();
            
            // Load notes
            loadNotes();
            
            // Show landing page
            getElement('landingPage').style.display = 'block';
            getElement('appContainer').classList.remove('active');
            getElement('adminDashboard').classList.remove('active');
            
            console.log('‚úÖ App initialized');
        });
        
        // ========== ONLINE/OFFLINE HANDLING ==========
        function handleOnline() {
            isOnline = true;
            showNotification('You are back online', 'success');
            
            // Try to send unsent messages
            sendUnsentMessages();
            
            // Refresh data
            if (currentUser) {
                syncUserWithDatabase();
            }
        }
        
        function handleOffline() {
            isOnline = false;
            // NO WARNING NOTIFICATION - Messages will queue and send when back online
        }
        
        // ========== DATABASE FUNCTIONS ==========
        async function getAllUsersFromDatabase() {
            try {
                let users = [];
                
                if (supabaseClient && isOnline) {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è Using cached users:', error.message);
                        const cached = localStorage.getItem('batanai_users_cache');
                        users = cached ? JSON.parse(cached) : [];
                    } else {
                        users = data.map(user => ({
                            id: user.id,
                            phone: user.phone,
                            name: user.name || 'Unknown',
                            city: user.city || 'Unknown',
                            avatar: user.avatar || '',
                            contacts: user.contacts || [],
                            blockedContacts: user.blocked_contacts || [],
                            pinCode: user.pin_code || '',
                            isActive: user.is_active || false,
                            isBlocked: user.is_blocked || false,
                            hasPaid: user.has_paid || false,
                            isAdmin: user.is_admin || false,
                            expiryDate: user.expiry_date,
                            createdAt: user.created_at,
                            lastSeen: user.last_seen,
                            updatedAt: user.updated_at
                        }));
                        
                        // Cache users
                        localStorage.setItem('batanai_users_cache', JSON.stringify(users));
                    }
                } else {
                    const cached = localStorage.getItem('batanai_users_cache');
                    users = cached ? JSON.parse(cached) : [];
                }
                
                // Also check local users
                const localUsers = JSON.parse(localStorage.getItem('batanai_users') || '[]');
                users = [...users, ...localUsers];
                
                // Remove duplicates
                const uniqueUsers = [];
                const seenPhones = new Set();
                
                users.forEach(user => {
                    if (!seenPhones.has(user.phone)) {
                        seenPhones.add(user.phone);
                        uniqueUsers.push(user);
                    }
                });
                
                allUsers = uniqueUsers;
                return uniqueUsers;
            } catch (error) {
                console.error('‚ùå Error getting users:', error);
                const cached = localStorage.getItem('batanai_users_cache');
                return cached ? JSON.parse(cached) : [];
            }
        }
        
        async function saveUserToDatabase(user) {
            try {
                // Always save to localStorage first
                let users = JSON.parse(localStorage.getItem('batanai_users') || '[]');
                const index = users.findIndex(u => u.id === user.id);
                
                if (index !== -1) {
                    users[index] = user;
                } else {
                    users.push(user);
                }
                localStorage.setItem('batanai_users', JSON.stringify(users));
                
                // Update cache
                const cached = JSON.parse(localStorage.getItem('batanai_users_cache') || '[]');
                const cacheIndex = cached.findIndex(u => u.id === user.id);
                
                if (cacheIndex !== -1) {
                    cached[cacheIndex] = user;
                } else {
                    cached.push(user);
                }
                localStorage.setItem('batanai_users_cache', JSON.stringify(cached));
                
                // Update current user if it's them
                if (currentUser && currentUser.id === user.id) {
                    currentUser = { ...currentUser, ...user };
                    localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                    updateUserAvatar();
                }
                
                // Try to save to Supabase if online
                if (supabaseClient && isOnline) {
                    const { error } = await supabaseClient
                        .from('users')
                        .upsert({
                            id: user.id,
                            phone: user.phone,
                            name: user.name,
                            city: user.city,
                            avatar: user.avatar || '',
                            contacts: user.contacts || [],
                            blocked_contacts: user.blockedContacts || [],
                            pin_code: user.pinCode || '',
                            is_active: user.isActive || false,
                            is_blocked: user.isBlocked || false,
                            has_paid: user.hasPaid || false,
                            is_admin: user.isAdmin || false,
                            expiry_date: user.expiryDate,
                            created_at: user.createdAt || new Date().toISOString(),
                            last_seen: user.lastSeen || new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'id'
                        });
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è User saved locally, will sync later:', error.message);
                        return false;
                    }
                    
                    console.log('‚úÖ User saved to database:', user.phone);
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('‚ùå Error saving user:', error);
                return false;
            }
        }
        
        async function deleteUserFromDatabase(userId) {
            try {
                // Remove from localStorage
                let users = JSON.parse(localStorage.getItem('batanai_users') || '[]');
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('batanai_users', JSON.stringify(users));
                
                // Remove from cache
                let cached = JSON.parse(localStorage.getItem('batanai_users_cache') || '[]');
                cached = cached.filter(u => u.id !== userId);
                localStorage.setItem('batanai_users_cache', JSON.stringify(cached));
                
                // Try to delete from Supabase if online
                if (supabaseClient && isOnline) {
                    const { error } = await supabaseClient
                        .from('users')
                        .delete()
                        .eq('id', userId);
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è User deleted locally:', error.message);
                        return false;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                return false;
            }
        }
        
        // ========== NOTES FUNCTIONS ==========
        function loadNotes() {
            const savedNotes = localStorage.getItem('batanai_notes');
            notes = savedNotes ? JSON.parse(savedNotes) : [];
            
            // Filter notes for current user
            if (currentUser) {
                notes = notes.filter(note => note.userId === currentUser.id);
            }
        }
        
        function saveNotes() {
            localStorage.setItem('batanai_notes', JSON.stringify(notes));
        }
        
        function showNotesModal() {
            getElement('notesModal').classList.add('active');
            renderNotes();
        }
        
        function renderNotes() {
            const container = getElement('notesContainer');
            
            if (notes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999; grid-column: 1 / -1;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">üìù</div>
                        <h4 style="margin-bottom: 10px; color: var(--dark);">No Notes Yet</h4>
                        <p style="color: var(--secondary);">Add your first note above.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notes.forEach((note, index) => {
                const date = new Date(note.date).toLocaleDateString();
                html += `
                    <div class="note-item note-${note.color}" style="animation-delay: ${index * 0.05}s">
                        <div class="note-actions">
                            <button class="note-action-btn" onclick="editNote('${note.id}')">‚úèÔ∏è</button>
                            <button class="note-action-btn" onclick="deleteNote('${note.id}')">üóëÔ∏è</button>
                        </div>
                        <div class="note-content">${escapeHtml(note.text)}</div>
                        <div class="note-date">${date}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function addNote() {
            const text = getElement('newNoteText').value.trim();
            if (!text) {
                showNotification('Please enter note text', 'error');
                return;
            }
            
            const newNote = {
                id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                userId: currentUser.id,
                text: text,
                color: selectedNoteColor,
                date: new Date().toISOString()
            };
            
            notes.unshift(newNote); // Add to beginning
            saveNotes();
            
            getElement('newNoteText').value = '';
            renderNotes();
            showNotification('Note added', 'success');
        }
        
        function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            
            const newText = prompt('Edit note:', note.text);
            if (newText !== null) {
                note.text = newText;
                saveNotes();
                renderNotes();
                showNotification('Note updated', 'success');
            }
        }
        
        function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            notes = notes.filter(n => n.id !== noteId);
            saveNotes();
            renderNotes();
            showNotification('Note deleted', 'success');
        }
        
        // ========== MESSAGES DATABASE ==========
        async function saveMessageToDatabase(message) {
            try {
                // Save to localStorage first for immediate display
                const conversationId = [message.senderId, message.receiverId].sort().join('_');
                let allMessages = JSON.parse(localStorage.getItem('batanai_all_messages') || '{}');
                
                if (!allMessages[conversationId]) {
                    allMessages[conversationId] = [];
                }
                
                allMessages[conversationId].push(message);
                localStorage.setItem('batanai_all_messages', JSON.stringify(allMessages));
                
                // Also save to individual user's messages
                if (!messages.has(message.receiverId)) {
                    messages.set(message.receiverId, []);
                }
                messages.get(message.receiverId).push(message);
                saveMessages();
                
                // Save to Supabase if online (cross-city messaging)
                if (supabaseClient && isOnline) {
                    const { error } = await supabaseClient
                        .from('messages')
                        .insert({
                            id: message.id,
                            content: message.content,
                            sender_id: message.senderId,
                            receiver_id: message.receiverId,
                            type: 'text',
                            created_at: message.timestamp
                        });
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è Message saved locally, will retry:', error.message);
                        
                        // Add to unsent messages if failed
                        addUnsentMessage(message);
                        updateMessageStatus(message.id, 'pending');
                        return false;
                    }
                    
                    console.log('‚úÖ Message saved to database');
                    
                    // Mark message as delivered
                    updateMessageStatus(message.id, 'delivered');
                    
                    // Also update the other user's local storage for cross-device sync
                    if (message.receiverId && message.receiverId !== currentUser.id) {
                        const otherUserConversationId = [message.senderId, message.receiverId].sort().join('_');
                        let otherUserMessages = JSON.parse(localStorage.getItem('batanai_all_messages') || '{}');
                        
                        if (!otherUserMessages[otherUserConversationId]) {
                            otherUserMessages[otherUserConversationId] = [];
                        }
                        
                        // Don't add duplicate
                        const exists = otherUserMessages[otherUserConversationId].some(m => m.id === message.id);
                        if (!exists) {
                            otherUserMessages[otherUserConversationId].push(message);
                            localStorage.setItem('batanai_all_messages', JSON.stringify(otherUserMessages));
                        }
                    }
                    
                    return true;
                } else {
                    // Offline - mark as pending (no warning notification)
                    addUnsentMessage(message);
                    updateMessageStatus(message.id, 'pending');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error saving message:', error);
                addUnsentMessage(message);
                updateMessageStatus(message.id, 'pending');
                return false;
            }
        }
        
        async function loadMessagesFromDatabase(contactId) {
            try {
                let contactMessages = [];
                const conversationId = [currentUser.id, contactId].sort().join('_');
                
                // Try Supabase first if online (works across Zimbabwe cities)
                if (supabaseClient && isOnline) {
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .select('*')
                        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${contactId}),and(sender_id.eq.${contactId},receiver_id.eq.${currentUser.id})`)
                        .order('created_at', { ascending: true });
                    
                    if (!error && data) {
                        contactMessages = data.map(msg => ({
                            id: msg.id,
                            type: msg.type,
                            content: msg.content,
                            senderId: msg.sender_id,
                            receiverId: msg.receiver_id,
                            timestamp: msg.created_at,
                            status: 'delivered'
                        }));
                    }
                }
                
                // Fallback to localStorage
                if (contactMessages.length === 0) {
                    const allMessages = JSON.parse(localStorage.getItem('batanai_all_messages') || '{}');
                    if (allMessages[conversationId]) {
                        contactMessages = allMessages[conversationId];
                    }
                }
                
                // Also check local messages map
                if (messages.has(contactId)) {
                    const localMessages = messages.get(contactId);
                    // Merge and remove duplicates
                    const messageIds = new Set();
                    const merged = [];
                    
                    [...contactMessages, ...localMessages].forEach(msg => {
                        if (!messageIds.has(msg.id)) {
                            messageIds.add(msg.id);
                            merged.push(msg);
                        }
                    });
                    
                    contactMessages = merged.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                }
                
                return contactMessages;
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
                return messages.get(contactId) || [];
            }
        }
        
        // ========== UNSENT MESSAGES HANDLING ==========
        function loadUnsentMessages() {
            const saved = localStorage.getItem('batanai_unsent_messages');
            unsentMessages = saved ? JSON.parse(saved) : [];
            
            if (unsentMessages.length > 0 && isOnline) {
                sendUnsentMessages();
            }
        }
        
        function addUnsentMessage(message) {
            unsentMessages.push(message);
            localStorage.setItem('batanai_unsent_messages', JSON.stringify(unsentMessages));
        }
        
        function removeUnsentMessage(messageId) {
            unsentMessages = unsentMessages.filter(msg => msg.id !== messageId);
            localStorage.setItem('batanai_unsent_messages', JSON.stringify(unsentMessages));
        }
        
        async function sendUnsentMessages() {
            if (!isOnline || unsentMessages.length === 0) return;
            
            console.log('üîÑ Sending', unsentMessages.length, 'unsent messages...');
            
            let successCount = 0;
            
            // Create a copy to avoid mutation during iteration
            const messagesToSend = [...unsentMessages];
            
            for (const message of messagesToSend) {
                try {
                    if (supabaseClient) {
                        const { error } = await supabaseClient
                            .from('messages')
                            .insert({
                                id: message.id,
                                content: message.content,
                                sender_id: message.senderId,
                                receiver_id: message.receiverId,
                                type: 'text',
                                created_at: message.timestamp
                            });
                        
                        if (error) {
                            console.warn('‚ùå Failed to send unsent message:', error);
                            
                            // If it's a connection error, keep it in unsent
                            if (!error.message.includes('duplicate') && !error.message.includes('network')) {
                                // Keep in unsent for retry
                            } else {
                                // Remove duplicate or successfully sent messages
                                removeUnsentMessage(message.id);
                                updateMessageStatus(message.id, 'delivered');
                                successCount++;
                            }
                        } else {
                            // Successfully sent
                            removeUnsentMessage(message.id);
                            updateMessageStatus(message.id, 'delivered');
                            successCount++;
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error sending unsent message:', error);
                    // Keep in unsent for retry
                }
            }
            
            if (successCount > 0) {
                console.log(`‚úÖ ${successCount} message(s) sent successfully`);
                // NO NOTIFICATION - messages sent silently
            }
            // NO WARNING NOTIFICATION for failed messages
        }
        
        function updateMessageStatus(messageId, status) {
            // Find message in UI and update status
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement) {
                    let icon = 'üïí';
                    if (status === 'delivered') icon = '‚úì‚úì';
                    if (status === 'sent') icon = '‚úì';
                    
                    statusElement.innerHTML = `${icon} ${status}`;
                    statusElement.style.color = status === 'delivered' ? 'var(--primary)' : 
                                               status === 'sent' ? '#999' : '#999';
                }
            }
            
            // Update in local storage
            if (currentContact) {
                const conversationId = [currentUser.id, currentContact.id].sort().join('_');
                const allMessages = JSON.parse(localStorage.getItem('batanai_all_messages') || '{}');
                
                if (allMessages[conversationId]) {
                    const msgIndex = allMessages[conversationId].findIndex(m => m.id === messageId);
                    if (msgIndex !== -1) {
                        allMessages[conversationId][msgIndex].status = status;
                        localStorage.setItem('batanai_all_messages', JSON.stringify(allMessages));
                    }
                }
            }
        }
        
        // ========== REAL-TIME MESSAGING ==========
        async function setupRealtimeListener() {
            if (!supabaseClient || !currentUser || !isOnline) return;
            
            // Unsubscribe from existing subscription
            if (realtimeSubscription) {
                supabaseClient.removeChannel(realtimeSubscription);
            }
            
            // Subscribe to new messages (works across all Zimbabwe cities)
            realtimeSubscription = supabaseClient
                .channel('public:messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages',
                        filter: `receiver_id=eq.${currentUser.id}`
                    }, 
                    async (payload) => {
                        console.log('üì© New message received via real-time:', payload.new);
                        
                        const message = payload.new;
                        const senderId = message.sender_id;
                        
                        // Check if sender is blocked
                        if (currentUser.blockedContacts && currentUser.blockedContacts.includes(senderId)) {
                            return; // Ignore messages from blocked contacts
                        }
                        
                        // Check if sender is in contacts
                        const contact = contacts.find(c => c.id === senderId);
                        if (contact) {
                            // Add message to local storage
                            const msgObj = {
                                id: message.id,
                                type: message.type,
                                content: message.content,
                                senderId: message.sender_id,
                                receiverId: message.receiver_id,
                                timestamp: message.created_at,
                                status: 'delivered'
                            };
                            
                            if (!messages.has(senderId)) {
                                messages.set(senderId, []);
                            }
                            
                            // Check if message already exists
                            const existingMsg = messages.get(senderId).find(m => m.id === msgObj.id);
                            if (!existingMsg) {
                                messages.get(senderId).push(msgObj);
                                saveMessages();
                                
                                // Also save to all_messages
                                const conversationId = [currentUser.id, senderId].sort().join('_');
                                let allMessages = JSON.parse(localStorage.getItem('batanai_all_messages') || '{}');
                                
                                if (!allMessages[conversationId]) {
                                    allMessages[conversationId] = [];
                                }
                                
                                allMessages[conversationId].push(msgObj);
                                localStorage.setItem('batanai_all_messages', JSON.stringify(allMessages));
                                
                                // Show notification only if app is hidden
                                if (document.hidden || (!currentContact || currentContact.id !== senderId)) {
                                    showNotification(`New message from ${contact.name}`, 'info');
                                }
                                
                                // If currently viewing this contact's chat, update messages
                                if (currentContact && currentContact.id === senderId) {
                                    await loadMessages(senderId);
                                }
                                
                                // Update contact's last message in sidebar
                                renderContacts();
                            }
                        }
                    }
                )
                .subscribe();
            
            console.log('‚úÖ Real-time listener started for cross-city messaging');
        }
        
        // ========== USER MANAGEMENT ==========
        async function checkExistingUser() {
            const savedUser = localStorage.getItem('batanai_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('üë§ Found user:', currentUser.name);
                    
                    // Always sync with database
                    await syncUserWithDatabase();
                    
                    if (currentUser.isActive && currentUser.hasPaid && !currentUser.isBlocked) {
                        await showApp();
                    } else {
                        showInactiveOverlay();
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing user:', e);
                    localStorage.removeItem('batanai_user');
                }
            }
        }
        
        async function syncUserWithDatabase() {
            if (!currentUser || !isOnline) return;
            
            try {
                const users = await getAllUsersFromDatabase();
                const dbUser = users.find(u => u.phone === currentUser.phone);
                
                if (dbUser) {
                    // Merge database data with local data
                    const mergedUser = { ...currentUser, ...dbUser };
                    
                    // Preserve local avatar if it exists and is different
                    if (currentUser.avatar && currentUser.avatar !== dbUser.avatar) {
                        mergedUser.avatar = currentUser.avatar;
                    }
                    
                    currentUser = mergedUser;
                    localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                    updateUserAvatar();
                } else {
                    // Save user to database
                    await saveUserToDatabase(currentUser);
                }
                
                console.log('‚úÖ User synced');
            } catch (error) {
                console.error('‚ùå Sync error:', error);
            }
        }
        
        // ========== PROFILE PICTURE FUNCTIONS - FIXED ==========
        function updateUserAvatar() {
            if (!currentUser) return;
            
            const userAvatar = getElement('userAvatar');
            if (currentUser.avatar && currentUser.avatar.trim() !== '') {
                userAvatar.style.backgroundImage = `url('${currentUser.avatar}')`;
                userAvatar.textContent = '';
                userAvatar.style.backgroundColor = 'transparent';
            } else {
                userAvatar.style.backgroundImage = '';
                userAvatar.textContent = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
                userAvatar.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
                userAvatar.style.color = 'white';
            }
        }
        
        function updateContactAvatar(contactId, avatarUrl) {
            // Update in contacts list
            const contactItem = document.querySelector(`.chat-item[onclick*="${contactId}"] .chat-avatar`);
            if (contactItem) {
                if (avatarUrl && avatarUrl.trim() !== '') {
                    contactItem.style.backgroundImage = `url('${avatarUrl}')`;
                    contactItem.textContent = '';
                    contactItem.style.backgroundColor = 'transparent';
                } else {
                    contactItem.style.backgroundImage = '';
                    const contact = contacts.find(c => c.id === contactId);
                    contactItem.textContent = contact?.name ? contact.name.charAt(0).toUpperCase() : 'C';
                    const isActive = contact?.isActive && contact?.hasPaid && !contact?.isBlocked;
                    contactItem.style.background = isActive ? 
                        'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)' : 
                        'linear-gradient(135deg, var(--secondary) 0%, #667781 100%)';
                    contactItem.style.color = 'white';
                }
            }
            
            // Update in chat header if currently viewing this contact
            if (currentContact && currentContact.id === contactId) {
                const chatAvatar = getElement('currentChatAvatar');
                if (avatarUrl && avatarUrl.trim() !== '') {
                    chatAvatar.style.backgroundImage = `url('${avatarUrl}')`;
                    chatAvatar.textContent = '';
                    chatAvatar.style.backgroundColor = 'transparent';
                } else {
                    chatAvatar.style.backgroundImage = '';
                    chatAvatar.textContent = currentContact.name ? currentContact.name.charAt(0).toUpperCase() : 'C';
                    chatAvatar.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
                    chatAvatar.style.color = 'white';
                }
            }
        }
        
        // ========== REGISTRATION ==========
        async function handleRegister() {
            const name = getElement('registerName').value.trim();
            const phone = getElement('registerPhone').value.trim();
            const pin = getElement('registerPin').value.trim();
            const pinConfirm = getElement('registerPinConfirm').value.trim();
            const city = getElement('registerCity').value;
            
            if (!name || !phone || !pin || !pinConfirm || !city) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            const cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.length !== 9) {
                showNotification('Enter 9-digit Zimbabwe phone number', 'error');
                return;
            }
            
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showNotification('PIN must be 4 digits', 'error');
                return;
            }
            
            if (pin !== pinConfirm) {
                showNotification('PINs do not match', 'error');
                return;
            }
            
            // Check if user already exists
            const users = await getAllUsersFromDatabase();
            let existingUser = users.find(u => u.phone === cleanPhone);
            
            if (existingUser) {
                showNotification('Phone number already registered', 'error');
                return;
            }
            
            // Handle profile picture
            const profileInput = getElement('registerProfilePicture');
            let avatar = '';
            if (profileInput.files && profileInput.files[0]) {
                avatar = await readFileAsDataURL(profileInput.files[0]);
            }
            
            // Create new user
            const newUser = {
                id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                phone: cleanPhone,
                name: name,
                city: city,
                avatar: avatar,
                contacts: [],
                blockedContacts: [],
                pinCode: pin,
                isActive: false,
                isBlocked: false,
                hasPaid: false,
                isAdmin: false,
                createdAt: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                paymentReference: 'PAY' + Date.now().toString().slice(-6)
            };
            
            // Show loading
            const registerBtn = getElement('registerBtn');
            const originalText = registerBtn.innerHTML;
            registerBtn.disabled = true;
            registerBtn.innerHTML = 'Creating Account...';
            
            // Save to database
            const saved = await saveUserToDatabase(newUser);
            
            // Save to localStorage
            localStorage.setItem('batanai_user', JSON.stringify(newUser));
            currentUser = newUser;
            updateUserAvatar();
            
            // Restore button
            registerBtn.disabled = false;
            registerBtn.innerHTML = originalText;
            
            getElement('registerModal').classList.remove('active');
            
            if (saved) {
                showNotification('‚úÖ Account created! Remember your PIN: ' + pin, 'success');
            } else {
                showNotification('‚úÖ Account created locally! Remember your PIN: ' + pin, 'success');
            }
            
            // Force refresh admin users if admin is viewing
            if (document.querySelector('.admin-dashboard.active')) {
                await loadAdminUsers();
            }
            
            // Show payment instructions
            setTimeout(() => {
                showPaymentModal();
            }, 500);
        }
        
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }
        
        // ========== LOGIN ==========
        async function handleLogin() {
            const pin = getElement('loginPin').value.trim();
            if (!pin || pin.length !== 4) {
                showNotification('Enter 4-digit PIN', 'error');
                return;
            }
            
            // Get all users
            const users = await getAllUsersFromDatabase();
            
            // Find user by PIN
            let user = users.find(u => u.pinCode === pin);
            
            if (!user) {
                showNotification('Invalid PIN. Please register or try again.', 'error');
                return;
            }
            
            if (user.isBlocked) {
                showNotification('Account blocked. Contact support.', 'error');
                return;
            }
            
            if (!user.isActive || !user.hasPaid) {
                currentUser = user;
                localStorage.setItem('batanai_user', JSON.stringify(user));
                updateUserAvatar();
                getElement('loginModal').classList.remove('active');
                showInactiveOverlay();
                return;
            }
            
            currentUser = user;
            localStorage.setItem('batanai_user', JSON.stringify(user));
            updateUserAvatar();
            getElement('loginModal').classList.remove('active');
            await showApp();
            showNotification('Welcome back, ' + user.name + '!', 'success');
        }
        
        // ========== APP FUNCTIONS ==========
        async function showApp() {
            getElement('landingPage').style.display = 'none';
            getElement('appContainer').classList.add('active');
            getElement('adminDashboard').classList.remove('active');
            getElement('inactiveOverlay').style.display = 'none';
            
            updateUserInfo();
            await loadContacts();
            await loadBlockedContacts();
            loadAllMessages();
            showNoChatSelected();
            
            // Setup real-time listener for cross-city messaging
            await setupRealtimeListener();
            
            // Send any unsent messages
            sendUnsentMessages();
        }
        
        function showInactiveOverlay() {
            getElement('inactiveOverlay').style.display = 'flex';
            getElement('appContainer').classList.remove('active');
            getElement('adminDashboard').classList.remove('active');
        }
        
        function updateUserInfo() {
            if (!currentUser) return;
            
            const name = currentUser.name || 'User';
            getElement('userName').innerHTML = `
                ${escapeHtml(name)} 
                ${currentUser.isActive && currentUser.hasPaid && !currentUser.isBlocked ? 
                    '<span class="status-badge status-active">Premium</span>' : 
                    '<span class="status-badge status-inactive">Inactive</span>'}
            `;
            
            updateUserAvatar();
            
            let status = '';
            if (currentUser.isActive && currentUser.hasPaid && !currentUser.isBlocked) {
                if (currentUser.expiryDate) {
                    const daysLeft = Math.ceil((new Date(currentUser.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft > 0) {
                        status = `<span class="status-badge status-premium">${daysLeft} days left</span>`;
                    } else {
                        status = '<span class="status-badge status-warning">Expired</span>';
                    }
                } else {
                    status = '<span class="status-badge status-active">Active</span>';
                }
            } else if (currentUser.isBlocked) {
                status = '<span class="status-badge status-blocked">Blocked</span>';
            } else if (!currentUser.hasPaid) {
                status = '<span class="status-badge status-pending">Payment Pending</span>';
            } else {
                status = '<span class="status-badge status-inactive">Inactive</span>';
            }
            
            getElement('userStatus').innerHTML = status;
        }
        
        async function loadContacts() {
            if (!currentUser) return;
            
            const users = await getAllUsersFromDatabase();
            const contactIds = currentUser.contacts || [];
            
            // Filter out blocked contacts
            contacts = users.filter(user => 
                contactIds.includes(user.id) && 
                (!currentUser.blockedContacts || !currentUser.blockedContacts.includes(user.id))
            );
            renderContacts();
        }
        
        async function loadBlockedContacts() {
            if (!currentUser) return;
            
            const users = await getAllUsersFromDatabase();
            const blockedIds = currentUser.blockedContacts || [];
            
            // Get blocked contacts
            blockedContacts = users.filter(user => blockedIds.includes(user.id));
            renderBlockedContacts();
        }
        
        function renderContacts() {
            const chatsList = getElement('chatsList');
            if (contacts.length === 0) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3; animation: floatIcon 3s infinite ease-in-out;">üë•</div>
                        <h4 style="margin-bottom: 10px; color: var(--dark);">No Contacts Yet</h4>
                        <p style="margin-bottom: 30px; color: var(--secondary);">Add contacts to start chatting</p>
                        <button class="btn" id="addFirstContactBtn" style="max-width: 250px;">
                            Ôºã Add Your First Contact
                        </button>
                    </div>
                `;
                
                // Add click listener for the button
                setTimeout(() => {
                    const addBtn = getElement('addFirstContactBtn');
                    if (addBtn) {
                        addBtn.onclick = showNewContactModal;
                    }
                }, 100);
                return;
            }
            
            let html = '';
            contacts.forEach((contact, index) => {
                // Get last message
                const contactMessages = messages.get(contact.id) || [];
                const lastMessage = contactMessages.length > 0 ? 
                    contactMessages[contactMessages.length - 1].content : 'No messages yet';
                const lastSeen = contact.lastSeen ? formatLastSeen(contact.lastSeen) : 'Never';
                const isActive = contact.isActive && contact.hasPaid && !contact.isBlocked;
                
                // FIXED: Set avatar background - Simplified and working
                let avatarStyle = '';
                if (contact.avatar && contact.avatar.trim() !== '') {
                    avatarStyle = `background-image: url('${contact.avatar}'); background-size: cover; background-position: center; color: transparent;`;
                } else {
                    avatarStyle = isActive ? 
                        'background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;' :
                        'background: linear-gradient(135deg, var(--secondary) 0%, #667781 100%); color: white;';
                }
                
                html += `
                    <div class="chat-item" onclick="selectContact('${contact.id}')" style="animation-delay: ${index * 0.05}s">
                        <div class="chat-avatar" style="${avatarStyle}">
                            ${contact.avatar && contact.avatar.trim() !== '' ? '' : (contact.name ? contact.name.charAt(0).toUpperCase() : 'C')}
                        </div>
                        <div class="chat-info">
                            <h4>
                                ${escapeHtml(contact.name || 'Unknown')}
                                ${isActive ? '<span class="status-badge status-active" style="font-size: 0.7rem; padding: 2px 8px;">Online</span>' : ''}
                            </h4>
                            <p title="${escapeHtml(lastMessage)}">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">${escapeHtml(lastMessage)}</span>
                            </p>
                            <p style="font-size: 0.75rem; color: #999; margin-top: 3px;">
                                ${lastSeen} ‚Ä¢ ${contact.city || 'Unknown'}
                            </p>
                        </div>
                    </div>
                `;
            });
            
            chatsList.innerHTML = html;
        }
        
        function renderBlockedContacts() {
            const blockedList = getElement('blockedList');
            if (blockedContacts.length === 0) {
                blockedList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">üö´</div>
                        <h4 style="margin-bottom: 10px; color: var(--dark);">No Blocked Contacts</h4>
                        <p style="color: var(--secondary);">You haven't blocked any contacts yet.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            blockedContacts.forEach((contact, index) => {
                // Set avatar background
                let avatarStyle = '';
                if (contact.avatar && contact.avatar.trim() !== '') {
                    avatarStyle = `background-image: url('${contact.avatar}'); background-size: cover; background-position: center; color: transparent;`;
                } else {
                    avatarStyle = 'background: linear-gradient(135deg, var(--danger) 0%, #C2185B 100%); color: white;';
                }
                
                html += `
                    <div class="chat-item" style="animation-delay: ${index * 0.05}s">
                        <div class="chat-avatar" style="${avatarStyle}">
                            ${contact.avatar && contact.avatar.trim() !== '' ? '' : (contact.name ? contact.name.charAt(0).toUpperCase() : 'C')}
                        </div>
                        <div class="chat-info">
                            <h4>
                                ${escapeHtml(contact.name || 'Unknown')}
                                <span class="status-badge status-blocked" style="font-size: 0.7rem; padding: 2px 8px;">Blocked</span>
                            </h4>
                            <p style="color: var(--secondary);">
                                +263 ${contact.phone} ‚Ä¢ ${contact.city || 'Unknown'}
                            </p>
                        </div>
                        <div style="margin-left: auto;">
                            <button onclick="unblockContact('${contact.id}')" class="btn" style="padding: 8px 15px; font-size: 0.9rem; background: var(--success); color: white;">
                                ‚úÖ Unblock
                            </button>
                            <button onclick="backToContactsAfterBlock()" class="btn" style="padding: 8px 15px; font-size: 0.9rem; background: var(--primary); color: white; margin-left: 10px;">
                                ‚Üê Back
                            </button>
                        </div>
                    </div>
                `;
            });
            
            blockedList.innerHTML = html;
        }
        
        async function selectContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            currentContact = contact;
            
            // Update contact menu button text based on block status
            const isBlocked = currentUser.blockedContacts && currentUser.blockedContacts.includes(contactId);
            getElement('blockUnblockContactBtn').innerHTML = `
                ${isBlocked ? '‚úÖ Unblock Contact' : '‚ö†Ô∏è Block Contact'}
            `;
            
            getElement('currentChatName').innerHTML = `
                <span>${escapeHtml(contact.name || 'Unknown')}</span>
                <button class="contact-topup-btn" onclick="showTopupContactModal()" title="Top-up for contact" style="background: none; border: none; color: var(--purple); font-size: 1rem; cursor: pointer; margin-left: 10px;">üí∞</button>
            `;
            
            // FIXED: Set chat avatar - Simplified and working
            const chatAvatar = getElement('currentChatAvatar');
            if (contact.avatar && contact.avatar.trim() !== '') {
                chatAvatar.style.backgroundImage = `url('${contact.avatar}')`;
                chatAvatar.textContent = '';
                chatAvatar.style.backgroundColor = 'transparent';
                chatAvatar.style.color = 'transparent';
            } else {
                chatAvatar.style.backgroundImage = '';
                chatAvatar.textContent = contact.name ? contact.name.charAt(0).toUpperCase() : 'C';
                chatAvatar.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
                chatAvatar.style.color = 'white';
            }
            
            const isActive = contact.isActive && contact.hasPaid && !contact.isBlocked;
            getElement('currentChatStatus').innerHTML = `
                <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                    ${isActive ? 'Online' : 'Offline'}
                </span>
                <span>${contact.city || ''}</span>
            `;
            
            // Show chat interface
            getElement('noChatSelected').style.display = 'none';
            getElement('chatHeader').style.display = 'flex';
            getElement('messagesContainer').style.display = 'block';
            getElement('inputContainer').style.display = 'flex';
            
            if (window.innerWidth <= 768) {
                getElement('chatArea').classList.add('active');
            }
            
            await loadMessages(contactId);
            
            // Set focus on input
            setTimeout(() => {
                getElement('messageInput').focus();
            }, 100);
        }
        
        // ========== CONTACT MANAGEMENT ==========
        function showNewContactModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ûï Add New Contact</h2>
                        <button class="close-modal">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">üáøüáº Zimbabwe Phone Number</label>
                            <div class="phone-input">
                                <div class="country-code">+263</div>
                                <input type="tel" id="newContactPhone" placeholder="771234567" maxlength="9" pattern="[0-9]{9}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Name</label>
                            <input type="text" id="newContactName" class="form-control" placeholder="John Doe" required>
                        </div>
                        <div id="contactAddStatus" style="margin-bottom: 20px;"></div>
                        <button class="btn" id="addNewContactBtn">‚ûï Add Contact</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            modal.querySelector('#addNewContactBtn').addEventListener('click', async () => {
                const phone = modal.querySelector('#newContactPhone').value.trim();
                const name = modal.querySelector('#newContactName').value.trim();
                const statusDiv = modal.querySelector('#contactAddStatus');
                
                if (!phone || !name) {
                    showNotification('Please fill all fields', 'error');
                    return;
                }
                
                const cleanPhone = phone.replace(/\D/g, '');
                if (cleanPhone.length !== 9) {
                    showNotification('Enter 9-digit phone number', 'error');
                    return;
                }
                
                if (cleanPhone === currentUser.phone) {
                    showNotification('Cannot add yourself as contact', 'error');
                    return;
                }
                
                // Show loading
                const addBtn = modal.querySelector('#addNewContactBtn');
                const originalText = addBtn.innerHTML;
                addBtn.disabled = true;
                addBtn.innerHTML = 'Adding...';
                statusDiv.innerHTML = '<p style="color: #666;">Checking database...</p>';
                
                // Get all users
                const users = await getAllUsersFromDatabase();
                let contact = users.find(u => u.phone === cleanPhone);
                
                // Check if contact is blocked
                if (currentUser.blockedContacts && currentUser.blockedContacts.includes(contact?.id)) {
                    statusDiv.innerHTML = '<p style="color: var(--danger);">‚ùå This contact is blocked. Unblock them first.</p>';
                    addBtn.disabled = false;
                    addBtn.innerHTML = originalText;
                    return;
                }
                
                // If contact doesn't exist, create it
                if (!contact) {
                    statusDiv.innerHTML = '<p style="color: #666;">Creating new user...</p>';
                    
                    contact = {
                        id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        phone: cleanPhone,
                        name: name,
                        city: 'Unknown',
                        avatar: '',
                        contacts: [],
                        blockedContacts: [],
                        pinCode: Math.floor(1000 + Math.random() * 9000).toString(),
                        isActive: false,
                        isBlocked: false,
                        hasPaid: false,
                        isAdmin: false,
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString()
                    };
                    
                    // Save to database
                    await saveUserToDatabase(contact);
                    
                    statusDiv.innerHTML = '<p style="color: var(--success);">‚úÖ New contact created</p>';
                } else {
                    // Update name if different
                    if (contact.name !== name) {
                        contact.name = name;
                        await saveUserToDatabase(contact);
                    }
                    statusDiv.innerHTML = '<p style="color: var(--success);">‚úÖ Contact found</p>';
                }
                
                // Add to current user's contacts
                if (!currentUser.contacts) currentUser.contacts = [];
                
                if (currentUser.contacts.includes(contact.id)) {
                    statusDiv.innerHTML = '<p style="color: var(--danger);">‚ùå Contact already in your list</p>';
                    addBtn.disabled = false;
                    addBtn.innerHTML = originalText;
                    return;
                }
                
                currentUser.contacts.push(contact.id);
                
                // Update database
                await saveUserToDatabase(currentUser);
                localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                
                // Add to local contacts array
                if (!contacts.find(c => c.id === contact.id)) {
                    contacts.push(contact);
                }
                
                addBtn.disabled = false;
                addBtn.innerHTML = '‚úÖ Added!';
                
                setTimeout(() => {
                    modal.remove();
                    renderContacts();
                    showNotification('Contact added successfully', 'success');
                    
                    // Select the new contact
                    setTimeout(() => {
                        selectContact(contact.id);
                    }, 300);
                }, 1000);
            });
        }
        
        async function toggleBlockContact() {
            if (!currentContact) return;
            
            const isBlocked = currentUser.blockedContacts && currentUser.blockedContacts.includes(currentContact.id);
            
            if (isBlocked) {
                await unblockContact(currentContact.id);
            } else {
                await blockContact();
            }
        }
        
        async function blockContact() {
            if (!currentContact) return;
            
            if (!confirm(`Block ${currentContact.name}? You won't be able to message each other.`)) return;
            
            // Add to blocked list
            if (!currentUser.blockedContacts) currentUser.blockedContacts = [];
            if (!currentUser.blockedContacts.includes(currentContact.id)) {
                currentUser.blockedContacts.push(currentContact.id);
            }
            
            // Remove from contacts list
            currentUser.contacts = currentUser.contacts.filter(id => id !== currentContact.id);
            contacts = contacts.filter(c => c.id !== currentContact.id);
            
            // Update database
            await saveUserToDatabase(currentUser);
            localStorage.setItem('batanai_user', JSON.stringify(currentUser));
            
            // Update blocked contacts list
            if (!blockedContacts.find(c => c.id === currentContact.id)) {
                blockedContacts.push(currentContact);
            }
            
            showNotification(`${currentContact.name} blocked`, 'success');
            renderContacts();
            renderBlockedContacts();
            
            // Show blocked message with back button
            getElement('messagesContainer').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #999;">
                    <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">üö´</div>
                    <h4 style="margin-bottom: 10px; color: var(--dark);">Contact Blocked</h4>
                    <p style="color: var(--secondary); margin-bottom: 20px;">
                        You have blocked ${currentContact.name}. Unblock to see messages.
                    </p>
                    <button class="btn" onclick="unblockContact('${currentContact.id}')" style="max-width: 200px; margin-bottom: 10px;">
                        ‚úÖ Unblock Contact
                    </button>
                    <button class="btn btn-secondary" onclick="backToContactsAfterBlock()" style="max-width: 200px;">
                        ‚Üê Back to Contacts
                    </button>
                </div>
            `;
        }
        
        function backToContactsAfterBlock() {
            showNoChatSelected();
            switchTab('contacts');
        }
        
        async function unblockContact(contactId) {
            const contact = blockedContacts.find(c => c.id === contactId) || contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            if (!confirm(`Unblock ${contact.name}?`)) return;
            
            // Remove from blocked list
            if (currentUser.blockedContacts) {
                currentUser.blockedContacts = currentUser.blockedContacts.filter(id => id !== contactId);
            }
            
            // Add back to contacts if not already there
            if (!currentUser.contacts.includes(contactId)) {
                currentUser.contacts.push(contactId);
                if (!contacts.find(c => c.id === contactId)) {
                    contacts.push(contact);
                }
            }
            
            // Update database
            await saveUserToDatabase(currentUser);
            localStorage.setItem('batanai_user', JSON.stringify(currentUser));
            
            // Update lists
            blockedContacts = blockedContacts.filter(c => c.id !== contactId);
            
            showNotification(`${contact.name} unblocked`, 'success');
            renderContacts();
            renderBlockedContacts();
            
            // Update current contact menu if viewing this contact
            if (currentContact && currentContact.id === contactId) {
                getElement('blockUnblockContactBtn').innerHTML = '‚ö†Ô∏è Block Contact';
                // Reload messages
                await loadMessages(contactId);
            }
            
            // Switch back to contacts tab
            switchTab('contacts');
        }
        
        async function deleteContact() {
            if (!currentContact) return;
            
            if (!confirm(`Delete ${currentContact.name} and all conversations?`)) return;
            
            // Remove from contacts list
            contacts = contacts.filter(c => c.id !== currentContact.id);
            currentUser.contacts = currentUser.contacts.filter(id => id !== currentContact.id);
            await saveUserToDatabase(currentUser);
            
            // Delete messages
            messages.delete(currentContact.id);
            saveMessages();
            
            showNotification(`${currentContact.name} deleted`, 'success');
            renderContacts();
            backToContactsAfterBlock();
        }
        
        // ========== MESSAGES ==========
        function loadAllMessages() {
            const savedMessages = localStorage.getItem('batanai_messages');
            if (savedMessages) {
                try {
                    const parsed = JSON.parse(savedMessages);
                    parsed.forEach(([key, value]) => {
                        messages.set(key, value);
                    });
                    console.log(`üì® Loaded ${parsed.length} conversations`);
                } catch (e) {
                    console.error('‚ùå Error loading messages:', e);
                }
            }
        }
        
        function saveMessages() {
            const messagesArray = Array.from(messages.entries());
            localStorage.setItem('batanai_messages', JSON.stringify(messagesArray));
        }
        
        async function loadMessages(contactId) {
            const container = getElement('messagesContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading messages...</div>';
            
            // Check if contact is blocked
            const isBlocked = currentUser.blockedContacts && currentUser.blockedContacts.includes(contactId);
            if (isBlocked) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">üö´</div>
                        <h4 style="margin-bottom: 10px; color: var(--dark);">Contact Blocked</h4>
                        <p style="color: var(--secondary); margin-bottom: 20px;">
                            You have blocked this contact. Unblock to see messages.
                        </p>
                        <button class="btn" onclick="unblockContact('${contactId}')" style="max-width: 200px; margin-bottom: 10px;">
                            ‚úÖ Unblock Contact
                        </button>
                        <button class="btn btn-secondary" onclick="backToContactsAfterBlock()" style="max-width: 200px;">
                            ‚Üê Back to Contacts
                        </button>
                    </div>
                `;
                return;
            }
            
            // Load messages from database (works across cities)
            const contactMessages = await loadMessagesFromDatabase(contactId);
            messages.set(contactId, contactMessages);
            
            if (contactMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3; animation: floatIcon 3s infinite ease-in-out;">üí¨</div>
                        <h4 style="margin-bottom: 10px; color: var(--dark);">No messages yet</h4>
                        <p style="color: var(--secondary);">Start a conversation with ${currentContact?.name || 'this contact'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            contactMessages.forEach((msg, index) => {
                const isSent = msg.senderId === currentUser.id;
                const time = msg.timestamp ? formatTime(msg.timestamp) : 'Now';
                const status = msg.status || 'sent';
                const statusColor = status === 'delivered' ? 'var(--primary)' : 
                                  status === 'sent' ? '#999' : '#999';
                
                html += `
                    <div class="message ${isSent ? 'sent' : 'received'}" style="animation-delay: ${index * 0.05}s" data-message-id="${msg.id}">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                            <div class="message-time">
                                ${time}
                                ${isSent ? `<div class="message-status" style="color: ${statusColor};">${status === 'pending' ? 'üïí Pending' : status === 'sent' ? '‚úì Sent' : '‚úì‚úì Delivered'}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function sendMessage() {
            const input = getElement('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentContact) return;
            
            // Check if contact is blocked
            if (currentUser.blockedContacts && currentUser.blockedContacts.includes(currentContact.id)) {
                showNotification('Cannot send message to blocked contact', 'error');
                return;
            }
            
            if (!currentUser.isActive || !currentUser.hasPaid) {
                showNotification('Your account is not active. Please complete payment.', 'error');
                return;
            }
            
            if (!currentContact.isActive || !currentContact.hasPaid) {
                showNotification('Contact is not active. They need to complete payment.', 'error');
                return;
            }
            
            const message = {
                id: 'msg_' + Date.now() + '_' + (messageCounter++),
                type: 'text',
                content: text,
                senderId: currentUser.id,
                receiverId: currentContact.id,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };
            
            // Save message to database (works across all Zimbabwe cities)
            const saved = await saveMessageToDatabase(message);
            
            // Add message to UI
            const container = getElement('messagesContainer');
            
            // If it's the first message, clear the placeholder
            if (container.querySelector('div[style*="text-align: center"]')) {
                container.innerHTML = '';
            }
            
            const messageEl = document.createElement('div');
            messageEl.className = 'message sent';
            messageEl.setAttribute('data-message-id', message.id);
            messageEl.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-time">
                        ${formatTime(message.timestamp)}
                        <div class="message-status" style="color: ${saved ? '#999' : '#999'}">
                            ${saved ? '‚úì Sent' : 'üïí Pending'}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(messageEl);
            
            input.value = '';
            input.focus();
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
            
            // Update contact's last message in sidebar
            renderContacts();
            
            // NO OFFLINE WARNING NOTIFICATION - messages queue silently
        }
        
        // ========== TOP-UP FUNCTIONS ==========
        function showTopupModal() {
            const ref = Date.now().toString().slice(-6);
            getElement('topupReference').textContent = ref;
            getElement('topupModal').classList.add('active');
        }
        
        function showTopupContactModal() {
            if (!currentContact) return;
            
            const ref = Date.now().toString().slice(-6);
            getElement('topupContactName').textContent = currentContact.name;
            getElement('topupContactReference').textContent = ref;
            getElement('topupContactModal').classList.add('active');
        }
        
        function sendTopupProof() {
            const ref = getElement('topupReference').textContent;
            const weeks = getElement('topupWeeks').value;
            const amount = weeks * 0.5; // $1 per 2 weeks
            const message = `Batanai Top-up Proof\n\n` +
                          `My Phone: +263 ${currentUser?.phone || ''}\n` +
                          `Payment Reference: EXTEND${ref}\n` +
                          `Amount: $${amount} for ${weeks} weeks\n` +
                          `Please extend my subscription.`;
            
            const url = `https://wa.me/${WHATSAPP_SUPPORT.replace('+', '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showNotification('WhatsApp opened. Send payment proof.', 'info');
            getElement('topupModal').classList.remove('active');
        }
        
        function sendContactTopupProof() {
            if (!currentContact) return;
            
            const ref = getElement('topupContactReference').textContent;
            const weeks = getElement('topupContactWeeks').value;
            const amount = weeks * 0.5; // $1 per 2 weeks
            const message = `Batanai Contact Top-up Proof\n\n` +
                          `My Phone: +263 ${currentUser?.phone || ''}\n` +
                          `Contact Phone: +263 ${currentContact.phone}\n` +
                          `Contact Name: ${currentContact.name}\n` +
                          `Payment Reference: CONTACT${ref}\n` +
                          `Amount: $${amount} for ${weeks} weeks\n` +
                          `Please activate this contact's account.`;
            
            const url = `https://wa.me/${WHATSAPP_SUPPORT.replace('+', '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showNotification('WhatsApp opened. Send payment proof.', 'info');
            getElement('topupContactModal').classList.remove('active');
        }
        
        // ========== ADMIN DASHBOARD ==========
        async function showAdminDashboard() {
            getElement('adminDashboard').classList.add('active');
            getElement('appContainer').classList.remove('active');
            getElement('landingPage').style.display = 'none';
            
            // Unsubscribe from real-time if active
            if (realtimeSubscription) {
                supabaseClient.removeChannel(realtimeSubscription);
            }
            
            // Force refresh users
            await getAllUsersFromDatabase();
            await loadAdminData();
            await loadAdminUsers();
        }
        
        async function loadAdminData() {
            const users = await getAllUsersFromDatabase();
            
            const totalUsers = users.length;
            const activeUsers = users.filter(u => u.isActive && u.hasPaid && !u.isBlocked).length;
            const pendingUsers = users.filter(u => !u.isActive || !u.hasPaid).length;
            const blockedUsers = users.filter(u => u.isBlocked).length;
            
            // Calculate revenue
            let totalRevenue = 0;
            users.forEach(user => {
                if (user.hasPaid) {
                    totalRevenue += 1; // Base $1
                    if (user.expiryDate && user.createdAt) {
                        const start = new Date(user.createdAt);
                        const end = new Date(user.expiryDate);
                        const weeks = Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 7));
                        totalRevenue += Math.max(0, Math.floor((weeks - 2) / 2));
                    }
                }
            });
            
            getElement('adminStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value">${totalUsers}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value">${activeUsers}</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value">${pendingUsers}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">$${totalRevenue}</div>
                    <div class="stat-label">Revenue</div>
                </div>
            `;
        }
        
        async function loadAdminUsers(searchTerm = '') {
            let users = await getAllUsersFromDatabase();
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                users = users.filter(user => 
                    user.phone.includes(searchTerm) || 
                    (user.name && user.name.toLowerCase().includes(term))
                );
            }
            
            const usersList = getElement('usersList');
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üë•</div>
                        <h4 style="margin-bottom: 10px; color: white;">No Users Found</h4>
                        <p>${searchTerm ? 'Try a different search term' : 'No users registered yet.'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            users.forEach((user, index) => {
                let statusClass = 'status-inactive';
                let statusText = 'Inactive';
                let statusIcon = '‚è≥';
                
                if (user.isBlocked) {
                    statusClass = 'status-blocked';
                    statusText = 'Blocked';
                    statusIcon = '‚õî';
                } else if (user.isActive && user.hasPaid) {
                    statusClass = 'status-active';
                    statusText = 'Active';
                    statusIcon = '‚úÖ';
                } else if (!user.hasPaid) {
                    statusClass = 'status-pending';
                    statusText = 'Pending Payment';
                    statusIcon = 'üí∞';
                }
                
                // Format phone
                const phoneFormatted = user.phone.length === 9 ? 
                    `+263 ${user.phone}` : user.phone;
                
                // Format date
                const createdDate = user.createdAt ? 
                    new Date(user.createdAt).toLocaleDateString() : 'Unknown';
                
                // Days left
                let daysLeft = '';
                if (user.expiryDate) {
                    const days = Math.ceil((new Date(user.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days > 0) {
                        daysLeft = `<span class="status-badge status-premium">${days}d left</span>`;
                    }
                }
                
                // User avatar in admin dashboard
                const avatarContent = user.avatar && user.avatar.trim() !== '' ? 
                    `<div style="width: 100%; height: 100%; background-image: url('${user.avatar}'); background-size: cover; background-position: center;"></div>` :
                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: bold; font-size: 1.2rem;">${user.name ? user.name.charAt(0).toUpperCase() : '?'}</div>`;
                
                html += `
                    <div class="user-card" style="animation-delay: ${index * 0.1}s">
                        <div class="user-card-header">
                            <div class="user-card-avatar">
                                ${avatarContent}
                            </div>
                            <div class="user-card-info">
                                <h4>${escapeHtml(user.name || 'No Name')}</h4>
                                <p>
                                    <span>${phoneFormatted}</span>
                                    <span>‚Ä¢</span>
                                    <span>${user.city || 'Unknown'}</span>
                                    <span>‚Ä¢</span>
                                    <span>${createdDate}</span>
                                </p>
                                <p>
                                    <span class="status-badge ${statusClass}">${statusIcon} ${statusText}</span>
                                    ${user.hasPaid ? '<span class="status-badge status-active">üí∞ Paid</span>' : ''}
                                    ${daysLeft}
                                    <span class="status-badge" style="background: rgba(156, 39, 176, 0.2); color: var(--purple);">PIN: ${user.pinCode || 'N/A'}</span>
                                </p>
                            </div>
                        </div>
                        <div class="user-card-actions">
                            <button onclick="adminToggleUserStatus('${user.id}', ${!user.isActive})" 
                                    class="btn" style="background: ${user.isActive ? '#6c757d' : 'var(--primary)'}; color: white; padding: 8px 15px; font-size: 0.9rem;">
                                ${user.isActive ? '‚õî Deactivate' : '‚úÖ Activate'}
                            </button>
                            <button onclick="adminToggleBlockUser('${user.id}', ${!user.isBlocked})"
                                    class="btn" style="background: ${user.isBlocked ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 8px 15px; font-size: 0.9rem;">
                                ${user.isBlocked ? '‚úÖ Unblock' : '‚õî Block'}
                            </button>
                            <button onclick="adminDeleteUser('${user.id}')"
                                    class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            usersList.innerHTML = html;
        }
        
        // ========== ADMIN ACTIONS ==========
        async function adminToggleUserStatus(userId, activate) {
            if (!confirm(`${activate ? 'Activate' : 'Deactivate'} this user?`)) return;
            
            const users = await getAllUsersFromDatabase();
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            user.isActive = activate;
            
            if (activate) {
                user.hasPaid = true;
                // Set expiry date to 2 weeks from now
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 14);
                user.expiryDate = expiryDate.toISOString();
            }
            
            await saveUserToDatabase(user);
            
            // Update current user if it's them
            if (currentUser && currentUser.id === userId) {
                currentUser.isActive = user.isActive;
                currentUser.hasPaid = user.hasPaid;
                currentUser.expiryDate = user.expiryDate;
                localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                updateUserInfo();
                
                if (activate && !user.isBlocked) {
                    showApp();
                } else {
                    showInactiveOverlay();
                }
            }
            
            showNotification(`User ${activate ? 'activated' : 'deactivated'}`, 'success');
            loadAdminData();
            loadAdminUsers();
        }
        
        async function adminToggleBlockUser(userId, block) {
            if (!confirm(`${block ? 'Block' : 'Unblock'} this user?`)) return;
            
            const users = await getAllUsersFromDatabase();
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            user.isBlocked = block;
            await saveUserToDatabase(user);
            
            // Update current user if it's them
            if (currentUser && currentUser.id === userId) {
                currentUser.isBlocked = block;
                localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                updateUserInfo();
                
                if (block) {
                    showInactiveOverlay();
                } else if (currentUser.isActive && currentUser.hasPaid) {
                    showApp();
                }
            }
            
            showNotification(`User ${block ? 'blocked' : 'unblocked'}`, 'success');
            loadAdminData();
            loadAdminUsers();
        }
        
        async function adminDeleteUser(userId) {
            if (!confirm('DELETE this user permanently? This action cannot be undone!')) return;
            
            // Don't delete if it's the current user
            if (currentUser && currentUser.id === userId) {
                showNotification('Cannot delete yourself while logged in', 'error');
                return;
            }
            
            // Remove user from other users' contacts
            const allUsers = await getAllUsersFromDatabase();
            for (const user of allUsers) {
                if (user.contacts && user.contacts.includes(userId)) {
                    user.contacts = user.contacts.filter(id => id !== userId);
                    await saveUserToDatabase(user);
                }
                if (user.blockedContacts && user.blockedContacts.includes(userId)) {
                    user.blockedContacts = user.blockedContacts.filter(id => id !== userId);
                    await saveUserToDatabase(user);
                }
            }
            
            // Delete user
            await deleteUserFromDatabase(userId);
            
            showNotification('User deleted', 'success');
            loadAdminData();
            loadAdminUsers();
        }
        
        // ========== PAYMENT MODAL ==========
        function showPaymentModal() {
            const ref = Date.now().toString().slice(-6);
            getElement('paymentReference').textContent = ref;
            getElement('paymentModal').classList.add('active');
            
            if (currentUser) {
                currentUser.paymentReference = ref;
                localStorage.setItem('batanai_user', JSON.stringify(currentUser));
            }
        }
        
        function sendPaymentProof() {
            const ref = getElement('paymentReference').textContent;
            const phone = currentUser ? currentUser.phone : '';
            const message = `Batanai Chat Payment Proof\n\n` +
                          `My Phone: +263 ${phone}\n` +
                          `Payment Reference: BATANAI${ref}\n` +
                          `Please activate my account.`;
            
            const url = `https://wa.me/${WHATSAPP_SUPPORT.replace('+', '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showNotification('WhatsApp opened. Send your payment proof.', 'info');
        }
        
        // ========== PROFILE FUNCTIONS ==========
        function showProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            
            let subscriptionInfo = '';
            if (currentUser.expiryDate) {
                const expiry = new Date(currentUser.expiryDate);
                const today = new Date();
                const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                
                if (daysLeft > 0) {
                    subscriptionInfo = `
                        <div class="form-group">
                            <label class="form-label">Subscription Status</label>
                            <div style="padding: 20px; background: rgba(37, 211, 102, 0.1); border-radius: 15px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-weight: 700; color: var(--dark);">Premium Active</span>
                                    <span class="status-badge status-premium">
                                        üëë ${daysLeft} days left
                                    </span>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--secondary);">
                                    üìÖ Expires: ${expiry.toLocaleDateString()}
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    subscriptionInfo = `
                        <div class="form-group">
                            <label class="form-label">Subscription Status</label>
                            <div style="padding: 20px; background: rgba(255, 193, 7, 0.1); border-radius: 15px; border-left: 4px solid var(--warning);">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-weight: 700; color: var(--dark);">Subscription Expired</span>
                                    <span class="status-badge status-warning">
                                        ‚è≥ Expired
                                    </span>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--secondary); margin-top: 10px;">
                                    Please renew your subscription to continue using Batanai Chat.
                                </p>
                                <button class="btn" onclick="showTopupModal(); this.closest('.modal').remove();" style="margin-top: 15px;">
                                    üí∞ Renew Subscription
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else {
                subscriptionInfo = `
                    <div class="form-group">
                        <label class="form-label">Subscription Status</label>
                        <div style="padding: 20px; background: rgba(255, 56, 96, 0.1); border-radius: 15px; border-left: 4px solid var(--danger);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="font-weight: 700; color: var(--dark);">No Active Subscription</span>
                                <span class="status-badge status-inactive">
                                    ‚ùå Inactive
                                </span>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--secondary); margin-top: 10px;">
                                Complete payment to activate your account.
                            </p>
                            <button class="btn" onclick="showPaymentModal(); this.closest('.modal').remove();" style="margin-top: 15px;">
                                üí≥ Complete Payment
                            </button>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üë§ Your Profile</h2>
                        <button class="close-modal">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-upload">
                            <div class="profile-preview" id="profilePreview" style="background-image: url('${currentUser.avatar || ''}');">
                                ${currentUser.avatar && currentUser.avatar.trim() !== '' ? '' : 
                                    `<div style="font-size: 2.5rem; color: var(--secondary);">${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}</div>`
                                }
                            </div>
                            <label class="upload-btn">
                                üìÅ Change Profile Picture
                                <input type="file" id="profilePictureInput" accept="image/*">
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Account Details</label>
                            <div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 15px;">
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>üì± Phone:</strong> +263 ${currentUser.phone}
                                </p>
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>üîê PIN:</strong> ${currentUser.pinCode || 'Not set'}
                                </p>
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>üèôÔ∏è City:</strong> ${currentUser.city || 'Not set'}
                                </p>
                                <p style="color: var(--dark);">
                                    <strong>üìÖ Registered:</strong> ${new Date(currentUser.createdAt).toLocaleDateString()}
                                </p>
                            </div>
                        </div>
                        
                        ${subscriptionInfo}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px;">
                            <button class="btn" onclick="showNotesModal(); this.closest('.modal').remove();">
                                üìù My Notes
                            </button>
                            <button class="btn" onclick="showTopupModal(); this.closest('.modal').remove();">
                                üí∞ Top Up
                            </button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove();">
                                ‚úï Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            modal.querySelector('#profilePictureInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    showNotification('Image must be less than 2MB', 'error');
                    return;
                }
                
                try {
                    const avatar = await readFileAsDataURL(file);
                    currentUser.avatar = avatar;
                    
                    // Save to database
                    await saveUserToDatabase(currentUser);
                    localStorage.setItem('batanai_user', JSON.stringify(currentUser));
                    
                    // Update UI
                    const preview = modal.querySelector('#profilePreview');
                    preview.style.backgroundImage = `url('${avatar}')`;
                    preview.innerHTML = '';
                    
                    // Update all instances of the avatar
                    updateUserAvatar();
                    if (currentContact && currentContact.id === currentUser.id) {
                        updateContactAvatar(currentUser.id, avatar);
                    }
                    
                    showNotification('Profile picture updated', 'success');
                } catch (error) {
                    console.error('Error uploading profile picture:', error);
                    showNotification('Failed to update profile picture', 'error');
                }
            });
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function getElement(id) {
            return document.getElementById(id);
        }
        
        function showNotification(message, type = 'info') {
            const container = getElement('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = '‚ÑπÔ∏è';
            let title = 'Notification';
            
            switch(type) {
                case 'success':
                    icon = '‚úÖ';
                    title = 'Success';
                    break;
                case 'error':
                    icon = '‚ùå';
                    title = 'Error';
                    break;
                case 'warning':
                    icon = '‚ö†Ô∏è';
                    title = 'Warning';
                    break;
            }
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        ${icon}
                    </div>
                    <div class="notification-text">
                        <strong>${title}</strong>
                        <p>${escapeHtml(message)}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Never';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function showNoChatSelected() {
            getElement('noChatSelected').style.display = 'flex';
            getElement('chatHeader').style.display = 'none';
            getElement('messagesContainer').style.display = 'none';
            getElement('inputContainer').style.display = 'none';
            getElement('contactMenu').classList.remove('active');
            
            // Hide chat area on mobile
            if (window.innerWidth <= 768) {
                getElement('chatArea').classList.remove('active');
            }
        }
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (tabName === 'contacts') {
                getElement('contactsTab').classList.add('active');
                getElement('chatsList').style.display = 'block';
                getElement('blockedList').style.display = 'none';
            } else {
                getElement('blockedTab').classList.add('active');
                getElement('chatsList').style.display = 'none';
                getElement('blockedList').style.display = 'block';
            }
        }
        
        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Landing Page
            getElement('getStartedBtn').addEventListener('click', () => {
                getElement('registerModal').classList.add('active');
            });
            
            getElement('loginBtnLanding').addEventListener('click', () => {
                getElement('loginModal').classList.add('active');
            });
            
            getElement('makePaymentBtn').addEventListener('click', () => {
                showPaymentModal();
            });
            
            getElement('adminBtnLanding').addEventListener('click', () => {
                getElement('adminLoginModal').classList.add('active');
            });
            
            // Improved WhatsApp Share Functionality
            getElement('shareBtn').addEventListener('click', () => {
                const shareMessage = `üí¨ *BATANAI CHAT - Zimbabwe's Light Messenger*\n\n` +
                    `üöÄ *Ultra-Fast Messaging for Zimbabwe*\n` +
                    `üì± *Only $1 for 2 WEEKS Unlimited Chats*\n` +
                    `‚ú® *Features:*\n` +
                    `‚Ä¢ Real-time messaging\n` +
                    `‚Ä¢ Works on Econet, NetOne, Telecel\n` +
                    `‚Ä¢ Ultra-low data usage\n` +
                    `‚Ä¢ Beautiful interface\n` +
                    `‚Ä¢ Contact management with PIN login\n` +
                    `‚Ä¢ Multi-device support\n` +
                    `‚Ä¢ Personal notes with color coding\n\n` +
                    `üëë *Premium Zimbabwean App*\n` +
                    `üáøüáº *Proudly Zimbabwean*\n\n` +
                    `üîó *Register Now:* ${APP_URL}\n\n` +
                    `üì± *Use your Zimbabwe number: 07XXXXXXX*\n` +
                    `üîê *Create a 4-digit PIN for login*\n` +
                    `üí≥ *Only $1 for 2 weeks unlimited chats!*`;
                
                const url = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
                window.open(url, '_blank');
            });
            
            getElement('privacyPolicyLink').addEventListener('click', (e) => {
                e.preventDefault();
                getElement('privacyModal').classList.add('active');
            });
            
            // Login Modal
            getElement('loginBtn').addEventListener('click', handleLogin);
            getElement('registerLink').addEventListener('click', (e) => {
                e.preventDefault();
                getElement('loginModal').classList.remove('active');
                getElement('registerModal').classList.add('active');
            });
            
            // Register Modal
            getElement('registerBtn').addEventListener('click', handleRegister);
            getElement('registerProfilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        getElement('registerProfilePreview').style.backgroundImage = `url('${e.target.result}')`;
                        getElement('registerProfilePreview').innerHTML = '';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Admin Login
            getElement('adminLoginBtn').addEventListener('click', () => {
                const password = getElement('adminPassword').value;
                if (password === ADMIN_PASSWORD) {
                    getElement('adminLoginModal').classList.remove('active');
                    showAdminDashboard();
                    showNotification('Admin login successful', 'success');
                    getElement('adminPassword').value = '';
                } else {
                    showNotification('Wrong password', 'error');
                }
            });
            
            // Payment Modals
            getElement('sendPaymentProofBtn').addEventListener('click', sendPaymentProof);
            getElement('understandPaymentBtn').addEventListener('click', () => {
                getElement('paymentModal').classList.remove('active');
            });
            
            getElement('sendTopupProofBtn').addEventListener('click', sendTopupProof);
            getElement('sendContactTopupProofBtn').addEventListener('click', sendContactTopupProof);
            
            // Notes Modal
            getElement('addNoteBtn').addEventListener('click', addNote);
            
            // Color picker for notes
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedNoteColor = this.getAttribute('data-color');
                });
            });
            
            // Inactive Overlay
            getElement('makePaymentInactiveBtn').addEventListener('click', showPaymentModal);
            getElement('loginInactiveBtn').addEventListener('click', () => {
                getElement('inactiveOverlay').style.display = 'none';
                getElement('loginModal').classList.add('active');
            });
            
            // App Navigation
            getElement('profileBtn').addEventListener('click', showProfileModal);
            getElement('newContactBtn').addEventListener('click', showNewContactModal);
            getElement('notesBtn').addEventListener('click', showNotesModal);
            getElement('blockedContactsBtn').addEventListener('click', () => {
                switchTab('blocked');
            });
            getElement('logoutBtn').addEventListener('click', () => {
                if (confirm('Logout?')) {
                    // Unsubscribe from real-time
                    if (realtimeSubscription && supabaseClient) {
                        supabaseClient.removeChannel(realtimeSubscription);
                    }
                    localStorage.removeItem('batanai_user');
                    location.reload();
                }
            });
            
            // Tabs
            getElement('contactsTab').addEventListener('click', () => {
                switchTab('contacts');
            });
            
            getElement('blockedTab').addEventListener('click', () => {
                switchTab('blocked');
            });
            
            // Contact Menu
            getElement('contactMenuBtn').addEventListener('click', () => {
                getElement('contactMenu').classList.toggle('active');
            });
            
            getElement('viewContactProfileBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (currentContact) {
                    showContactProfileModal();
                }
            });
            
            getElement('blockUnblockContactBtn').addEventListener('click', (e) => {
                e.preventDefault();
                toggleBlockContact();
            });
            
            getElement('topupContactBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showTopupContactModal();
            });
            
            getElement('deleteContactBtn').addEventListener('click', (e) => {
                e.preventDefault();
                deleteContact();
            });
            
            // Chat Navigation
            getElement('backToContactsBtn').addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    getElement('chatArea').classList.remove('active');
                }
                showNoChatSelected();
                switchTab('contacts');
            });
            
            // Send Message
            getElement('sendBtn').addEventListener('click', sendMessage);
            getElement('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Search
            getElement('searchContacts').addEventListener('input', debounce(() => {
                const term = getElement('searchContacts').value.toLowerCase();
                const items = document.querySelectorAll('.chat-item');
                items.forEach(item => {
                    const name = item.querySelector('h4').textContent.toLowerCase();
                    const city = item.querySelector('p').textContent.toLowerCase();
                    if (name.includes(term) || city.includes(term)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }, 300));
            
            // Admin Dashboard
            getElement('backToChatBtn').addEventListener('click', async () => {
                getElement('adminDashboard').classList.remove('active');
                if (currentUser && currentUser.isActive && currentUser.hasPaid && !currentUser.isBlocked) {
                    await showApp();
                } else {
                    showInactiveOverlay();
                }
            });
            
            getElement('adminLogoutBtn').addEventListener('click', () => {
                getElement('adminDashboard').classList.remove('active');
                showNotification('Admin logged out', 'success');
            });
            
            getElement('adminSearchBtn').addEventListener('click', () => {
                const term = getElement('adminSearchInput').value;
                loadAdminUsers(term);
            });
            
            getElement('adminSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const term = getElement('adminSearchInput').value;
                    loadAdminUsers(term);
                }
            });
            
            // Close Modals
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('active');
                });
            });
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
                // Close contact menu when clicking outside
                if (!e.target.closest('.contact-menu') && !e.target.closest('.chat-action-btn')) {
                    getElement('contactMenu').classList.remove('active');
                }
            });
            
            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                    getElement('contactMenu').classList.remove('active');
                }
            });
        }
        
        function showContactProfileModal() {
            if (!currentContact) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üë§ ${escapeHtml(currentContact.name)}'s Profile</h2>
                        <button class="close-modal">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-upload">
                            <div class="profile-preview" style="background-image: url('${currentContact.avatar || ''}');">
                                ${currentContact.avatar && currentContact.avatar.trim() !== '' ? '' : 
                                    `<div style="font-size: 2.5rem; color: var(--secondary);">${currentContact.name ? currentContact.name.charAt(0).toUpperCase() : 'C'}</div>`
                                }
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contact Details</label>
                            <div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 15px;">
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>üì± Phone:</strong> +263 ${currentContact.phone}
                                </p>
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>üèôÔ∏è City:</strong> ${currentContact.city || 'Unknown'}
                                </p>
                                <p style="margin-bottom: 10px; color: var(--dark);">
                                    <strong>Status:</strong> 
                                    ${currentContact.isActive && currentContact.hasPaid && !currentContact.isBlocked ? 
                                        '<span class="status-badge status-active">Active</span>' : 
                                        '<span class="status-badge status-inactive">Inactive</span>'}
                                </p>
                                <p style="color: var(--dark);">
                                    <strong>üìÖ Last Seen:</strong> ${currentContact.lastSeen ? formatLastSeen(currentContact.lastSeen) : 'Never'}
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px;">
                            <button class="btn btn-purple" onclick="showTopupContactModal(); this.closest('.modal').remove();">
                                üí∞ Top Up for Contact
                            </button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove();">
                                ‚úï Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ========== GLOBAL FUNCTIONS ==========
        window.adminToggleUserStatus = adminToggleUserStatus;
        window.adminToggleBlockUser = adminToggleBlockUser;
        window.adminDeleteUser = adminDeleteUser;
        window.selectContact = selectContact;
        window.showNewContactModal = showNewContactModal;
        window.showTopupModal = showTopupModal;
        window.showTopupContactModal = showTopupContactModal;
        window.showProfileModal = showProfileModal;
        window.showPaymentModal = showPaymentModal;
        window.showNotesModal = showNotesModal;
        window.toggleBlockContact = toggleBlockContact;
        window.unblockContact = unblockContact;
        window.backToContactsAfterBlock = backToContactsAfterBlock;
        window.showContactProfileModal = showContactProfileModal;
        window.addNote = addNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
    </script>
</body>
</html>